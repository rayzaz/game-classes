// src/components/Portal.tsx
import React from 'react';
import '../styles.css';                  // ‚Üê –ü–†–ê–í–ò–õ–¨–ù–û (–æ–¥–Ω–∞ —Ç–æ—á–∫–∞)
import AssistantMereo from './AssistantMereo';
import AssistantRen from './AssistantRen';
import AssistantLumin from './AssistantLumin';
import MerioQuestionnaire from './assistants/Merio/MerioQuestionnaire';
import RenQuestionnaire from './assistants/Ren/RenQuestionnaire';
import LuminQuestionnaire from './assistants/Lumin/LuminQuestionnaire';
import { CLASSES } from "../data/classes";

type Props = { open: boolean; onClose: () => void };
type Phase =
  | 'loading'
  | 'welcome'
  | 'dialog'
  | 'about'
  | 'place'
  | 'register'
  | 'login'
  | 'questionnaire';

type AssistantDef = {
  id: 'mereo' | 'ren' | 'lumin';
  name: string;
  title: string;
  component: (p: { speaking: boolean }) => JSX.Element;
  about: string;
  place: string;
};

const ASSISTANTS: AssistantDef[] = [
  {
    id: 'mereo',
    name: '–ú–µ—Ä–µ–æ–ª–µ–æ–Ω–∞ –í–µ—Ä–º–∏–ª–ª–∏–æ–Ω',
    title: '–º–∞–≥ –æ–≥–Ω—è',
    component: (p) => <AssistantMereo speaking={p.speaking} />,
    about:
      '–•–∞! –¢—ã –µ—â—ë —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å, –∫—Ç–æ —è?! –Ø –ú–µ—Ä–µ–æ–ª–µ–æ–Ω–∞ –í–µ—Ä–º–∏–ª–ª–∏–æ–Ω, –∂–µ–Ω—â–∏–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∂–≥–ª–∞ –±–æ–ª—å—à–µ –±–∞–Ω–¥–∏—Ç–æ–≤, —á–µ–º —Ç–≤–æ–π –≥—Ä–∏–º—É–∞—Ä —Å—Ç—Ä–∞–Ω–∏—Ü –≤–∏–¥–µ–ª! ' +
      '–Ø –º–∞–≥ –æ–≥–Ω—è, –∏ –º–æ–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è –∂–≥—É—Ç —Ç–∞–∫, —á—Ç–æ –¥–∞–∂–µ —Å–∞–º –ê–¥ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç –¥–µ—Ä–∂–∞—Ç—å—Å—è –ø–æ–¥–∞–ª—å—à–µ. ' +
      '–ò –¥–∞, —Ä–∞–∑ —É–∂ —ç—Ç–∏ –∏–¥–∏–æ—Ç—ã-–∏–Ω–∂–µ–Ω–µ—Ä—ã –ø—Ä–∏–¥—É–º–∞–ª–∏ –≤–∞—à–∏ ¬´–ì–æ—Å–ú–∞–≥-—É—Å–ª—É–≥–∏¬ª, –Ω–æ –Ω–µ –ø—Ä–∏–¥—É–º–∞–ª–∏, –∫–∞–∫ –∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å ‚Äì –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –º–Ω–µ —Å–∏–¥–µ—Ç—å –∏ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –¥—É—Ä–∞—Ü–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã. ' +
      '–¢–∞–∫ —á—Ç–æ —Å–ª—É—à–∞–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ, –ø–æ–∫–∞ —É –º–µ–Ω—è —Ç–µ—Ä–ø–µ–Ω–∏–µ –Ω–µ —Å–≥–æ—Ä–µ–ª–æ –≤–º–µ—Å—Ç–µ —Å —ç—Ç–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º. ' +
      '–ê —Ç–µ–ø–µ—Ä—å ‚Äì —Ö–≤–∞—Ç–∏—Ç –≤–æ–ø—Ä–æ—Å–æ–≤, –∏–ª–∏ —è –ø—Ä–µ–≤—Ä–∞—â—É —ç—Ç—É –≤–∞—à—É ¬´–≥–æ—Å–ø—Ä–æ–≥—Ä–∞–º–º—É¬ª –≤ –∫–æ—Å—Ç—ë—Ä –¥–ª—è –±–∞—Ä–±–µ–∫—é!',
    place: `–≠—Ç–æ –ì–æ—Å.–ú–∞–≥.–£—Å–ª—É–≥–∏. –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Ä—Ç–∞–ª. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π. –°–∫—É—á–Ω—ã–π? –ù–µ—Ç. –ü–æ–ª–µ–∑–Ω—ã–π.
–¢—É—Ç —Ç—ã –æ—Ñ–æ—Ä–º–ª—è–µ—à—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –∞ –ø–æ—Å–ª–µ —ç–∫–∑–∞–º–µ–Ω–∞ –ø–æ–ª—É—á–∞–µ—à—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–±–∏–Ω–µ—Ç—É –∏ –∑–∞–¥–∞–Ω–∏—è–º –ø–æ —Ç–≤–æ–µ–º—É —É—Ä–æ–≤–Ω—é.

–ß—Ç–æ —É–º–µ–µ—Ç –ø–æ—Ä—Ç–∞–ª (–∑–∞–ø–æ–º–∏–Ω–∞–π, –ø–æ–≤—Ç–æ—Ä—è—Ç—å –Ω–µ –ª—é–±–ª—é):
‚Ä¢ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Äî –∞–Ω–∫–µ—Ç–∞, –ø—Ä–æ–≤–µ—Ä–∫–∞, –¥–æ–ø—É—Å–∫ –∫ —ç–∫–∑–∞–º–µ–Ω—É. –ë–µ–∑ –±—É–º–∞–∂–µ–∫ –≤ –±–æ–π –Ω–µ –ø–æ–π–¥—ë—à—å.
‚Ä¢ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî —É—Ä–æ–≤–µ–Ω—å, —Ä–∞–Ω–≥, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, —É–º–µ–Ω–∏—è, —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ, –ø—Ä–æ—Ç–æ–∫–æ–ª—ã.
‚Ä¢ –†–µ–π—Ç–∏–Ω–≥–∏ ‚Äî –≤–∏–¥–∏—à—å, –∫—Ç–æ –≤—ã—à–µ. –ó–∞—Ö–æ—á–µ—à—å ‚Äî –æ–±–≥–æ–Ω–∏—à—å.
‚Ä¢ –ó–∞–¥–∞–Ω–∏—è –ø–æ —Ä–∞–Ω–≥—É ‚Äî –±–µ—Ä—ë—à—å —Ç–æ, —á—Ç–æ –ø–æ—Ç—è–Ω–µ—à—å. –°–æ—Ä–≤—ë—à—å ‚Äî —Å–∞–º –≤–∏–Ω–æ–≤–∞—Ç.

–ò –¥–∞, –µ—Å–ª–∏ —Å–ª–æ–º–∞–µ—à—å —á—Ç–æ-—Ç–æ –≤ –ø–æ—Ä—Ç–∞–ª–µ ‚Äî —è —Ç–µ–±—è –∏–º –∂–µ –∏ –ø–æ–¥–∂–∞—Ä—é. –¢–µ–ø–µ—Ä—å ‚Äî –≤–ø–µ—Ä—ë–¥, –º–∞–≥.`,
  },
  {
    id: 'ren',
    name: '–†–µ–Ω –ü–∞—É–≤–∏–Ω–¥',
    title: '–º–∞–≥ –≤–µ—Ç—Ä–∞',
    component: (p) => <AssistantRen speaking={p.speaking} />,
    about:
      '–•–æ—Ä–æ—à–æ, —è –æ—Ç–≤–µ—á—É –Ω–∞ —Ç–≤–æ–π –≤–æ–ø—Ä–æ—Å. –Ø –†–µ–Ω –ü–∞—É–≤–∏–Ω–¥, –º–∞–≥ –≤–µ—Ç—Ä–∞ –∏ —Ä—ã—Ü–∞—Ä—å –∏–∑ –±–µ–∑—É–º–Ω–æ–≥–æ –æ—Ç—Ä—è–¥–∞ "–ß—ë—Ä–Ω—ã–π –±—ã–∫". ' +
      '–Ø –ª—é–±–ª—é –Ω–æ–≤—É—é –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ó–∞ —Å–≤–æ—é –∂–∏–∑–Ω—å —É –º–µ–Ω—è –±—ã–ª–æ –Ω–µ–º–∞–ª–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤. ' +
      '–ê —Ç–∞–∫–∂–µ —Ç—É—Ç —è –ø–æ–º–æ—â–Ω–∏–∫ –ú–µ—Ä–µ–æ–ª–µ–æ–Ω—ã –∫–∞—Å–∞–µ–º–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–Ω–∫–µ—Ç. ' +
      '–ú–µ–Ω—è –ø–æ–ø—Ä–æ—Å–∏–ª–∏ –ø–æ–º–æ—á—å –≤ –Ω–æ–≤—ã—Ö "–ì–æ—Å–ú–∞–≥–£—Å–ª—É–≥–∞—Ö", –Ω–æ –Ω–µ –±—É–¥—É —Å–∫—Ä—ã–≤–∞—Ç—å ‚Äî –º–Ω–µ –∏ —Å–∞–º–æ–º—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞ —ç—Ç–∞ –Ω–æ–≤–∞—è —à—Ç—É—á–∫–∞, –ø–æ—ç—Ç–æ–º—É —è –±—É–¥—É —Ä–∞–¥ –ø–æ–º–æ—á—å —Ç—É—Ç. ' +
      '–ê –ø–æ—Å–ª–µ –∂–µ —è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Å—å –∫ —Å–≤–æ–∏–º –¥–æ–º–∞—à–Ω–∏–º –¥–µ–ª–∞–º. ' +
      '–¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–∑—É—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –Ω–µ–æ–±—ã—á–Ω–æ–≥–æ –º–µ—Å—Ç–∞.',
    place: `–ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. –¢—ã –ø–æ–ø–∞–ª –≤ –ì–æ—Å.–ú–∞–≥.–£—Å–ª—É–≥–∏ ‚Äî –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –º–∞–≥–∏—á–µ—Å–∫–∏–π —Ä–µ–µ—Å—Ç—Ä –∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤.
–ó–¥–µ—Å—å –º–∞–≥–∏‚Ä¶ —ç-—ç, –≤—Ä–æ–¥–µ —Ç–µ–±—è‚Ä¶ —É–∑–∞–∫–æ–Ω–∏–≤–∞—é—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –∞ –ø–æ—Ç–æ–º –ø–æ–ª—É—á–∞—é—Ç –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å —Ü–∏—Ñ—Ä–∞–º–∏, –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –∏ –ø—Ä–æ—á–∏–º –≤–∫—É—Å–Ω—ã–º.

–ß—Ç–æ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å:
‚Ä¢ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è: –∞–Ω–∫–µ—Ç–∞ —É–ø—Ä–æ—Å—Ç–∏—Ç –∂–∏–∑–Ω—å —ç–∫–∑–∞–º–µ–Ω–∞—Ç–æ—Ä–∞–º –∏ –≤–∞—à–µ–º—É –±—É–¥—É—â–µ–º—É –∫–∞–ø–∏—Ç–∞–Ω—É.
‚Ä¢ –ü–æ—Å–ª–µ —ç–∫–∑–∞–º–µ–Ω–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∫–∞–±–∏–Ω–µ—Ç: —É—Ä–æ–≤–µ–Ω—å, —Ä–∞–Ω–≥, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—ë–≤, –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã, –Ω–∞–≤—ã–∫–∏ –∏ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ.
‚Ä¢ –†–µ–π—Ç–∏–Ω–≥: —Å—Ä–∞–≤–Ω–∏ —Å–µ–±—è —Å –¥—Ä—É–≥–∏–º–∏, —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –æ—Ç—Ä—è–¥–∞–º –∏ —Ä–∞–Ω–≥—É.
‚Ä¢ –ó–∞–¥–∞–Ω–∏—è –ø–æ —É—Ä–æ–≤–Ω—é: –ø–æ–¥–±–∏—Ä–∞–µ–º –∫–≤–µ—Å—Ç—ã –ø–æ–¥ —Ç–≤–æ—é –º–æ—â–Ω–æ—Å—Ç—å –∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é (—Ç–∞–Ω–∫, —Ö–∏–ª, –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ —Ç. –ø.).

–ù—É –≤—Å—ë, –≤–µ—Ç–µ—Ä —É–∫–∞–∂–µ—Ç –º–∞—Ä—à—Ä—É—Ç. –ü–æ–≥–Ω–∞–ª–∏.`,
  },
  {
    id: 'lumin',
    name: '–õ—é–º–∏–Ω –ü–∞—É–≤–∏–Ω–¥',
    title: '–º–∞–≥ –æ–≥–Ω—è –∏ —Ä–∞—Å—Ç–µ–Ω–∏–π',
    component: (p) => <AssistantLumin speaking={p.speaking} />,
    about:
      '–í–∏–∂—É —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∫–æ –º–Ω–µ –∏ —è –º–æ–≥—É –Ω–∞ –Ω–∏—Ö –æ—Ç–≤–µ—Ç–∏—Ç—å. ' +
      '–ú–µ–Ω—è –∑–æ–≤—É—Ç –õ—é–º–∏–Ω –ü–∞—É–≤–∏–Ω–¥, —è –Ω–µ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ –∏ –∏–º–µ—é –¥–≤–µ –º–∞–≥–∏–∏: –æ–¥–Ω–∞ –∏–∑ –Ω–∏—Ö —ç—Ç–æ –º–∞–≥–∏—è –æ–≥–Ω—è —á—Ç–æ —Å–∂–∏–≥–∞–µ—Ç –≤—Å—ë –Ω–∞ –ø—É—Ç–∏, –∞ –≤—Ç–æ—Ä–∞—è –º–∞–≥–∏—è —Ä–∞—Å—Ç–µ–Ω–∏–π. ' +
      '–Ø —Å–æ—Å—Ç–æ—é –≤ —Å–∞–º–æ–º —Å–∫—Ä—ã—Ç–æ–º –æ—Ç—Ä—è–¥–µ "–ö–∞–π—Ä–∞–ª–æ–≤—ã–π –ø—Ä–∏–∑—Ä–∞–∫". –ú–æ–∏ —É–≤–ª–µ—á–µ–Ω–∏—è —ç—Ç–æ –≥–æ—Ç–æ–≤–∫–∞ –∏ –æ–≥–æ—Ä–æ–¥, –≤—Å–µ–≥–¥–∞ –∏—â—É –Ω–æ–≤—ã–µ –∏–¥–µ–∏ –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞ –∏ –Ω–µ —Å–∏–∂—É –Ω–∞ –º–µ—Å—Ç–µ. ' +
      '–ú–æ—è –∂–∏–∑–Ω—å –±–æ–ª–µ–µ —Å–ø–æ–∫–æ–π–Ω–∞—è, –æ –∫–æ—Ç–æ—Ä–æ–π –º–µ—á—Ç–∞—é—Ç –º–Ω–æ–≥–∏–µ. –¢–∞–∫ –∂–µ —è –ø–æ–º–æ–≥–∞—é –ú–µ—Ä–µ–æ–ª–µ–æ–Ω–µ —Å –∏–≤–µ–Ω—Ç–∞–º–∏ –∏ –∞—Ä—Ç–∞–º–∏ –¥–ª—è –≤–∞—à–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π. ' +
      '–ú–µ–Ω—è –ø–æ–ø—Ä–æ—Å–∏–ª–∏ –ø–æ–º–æ—á—å –≤ –Ω–æ–≤—ã—Ö "–ì–æ—Å–ú–∞–≥–£—Å–ª—É–≥–∞—Ö", –Ω–æ –Ω–µ –±—É–¥—É —Å–∫—Ä—ã–≤–∞—Ç—å ‚Äî –º–Ω–µ –∏ —Å–∞–º–æ–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞ —ç—Ç–∞ –Ω–æ–≤–∞—è —à—Ç—É—á–∫–∞, –ø–æ—ç—Ç–æ–º—É —è –±—É–¥—É —Ä–∞–¥–∞ –ø–æ–º–æ—á—å —Ç—É—Ç. ' +
      '–ê –ø–æ—Å–ª–µ –∂–µ —è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Å—å –∫ —Å–≤–æ–∏–º –æ–≥–æ—Ä–æ–¥–∞–º –∏ –ª—é–±–∏–º–æ–π —Å–µ–º—å–µ. ' +
      '–¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–∑—É—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –Ω–µ–æ–±—ã—á–Ω–æ–≥–æ –º–µ—Å—Ç–∞.',
    place: `–í—ã –≤ –ì–æ—Å.–ú–∞–≥.–£—Å–ª—É–≥–∞—Ö ‚Äî —ç—Ç–æ —Ç–∏—Ö–∏–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –º–∞–≥–æ–≤. –ó–¥–µ—Å—å –≤—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –≤–∞—à –ø—É—Ç—å –±—ã–ª –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–º –∏ –∑–∞–∫–æ–Ω–Ω—ã–º.

–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ—Ä—Ç–∞–ª–∞:
‚Ä¢ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —á–µ—Ä–µ–∑ –∞–Ω–∫–µ—Ç—É ‚Äî –±—ã—Å—Ç—Ä–æ, –±–µ–∑ –æ—á–µ—Ä–µ–¥–µ–π.
‚Ä¢ –î–æ—Å—Ç—É–ø –ø–æ—Å–ª–µ —ç–∫–∑–∞–º–µ–Ω–∞: –≤–∞—à —É—Ä–æ–≤–µ–Ω—å, —Ä–∞–Ω–≥, –∂—É—Ä–Ω–∞–ª —É–º–µ–Ω–∏–π, –∏—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞–Ω–∏–π.
‚Ä¢ –†–µ–π—Ç–∏–Ω–≥–∏ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ ‚Äî –º—è–≥–∫–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è —Ä–∞—Å—Ç–∏, –±–µ–∑ –∏–∑–ª–∏—à–Ω–µ–π —Å—É–µ—Ç—ã.
‚Ä¢ –ü–æ–¥–±–æ—Ä –∑–∞–¥–∞–Ω–∏–π –ø–æ —Ä–∞–Ω–≥—É –∏ —Ä–æ–ª–∏: –¥–∞–º–∞–≥, –ø–æ–¥–¥–µ—Ä–∂–∫–∞, —Ç–∞–Ω–∫, –∫–æ–Ω—Ç—Ä–æ–ª—å ‚Äî –ª–∏—à–Ω–µ–≥–æ –Ω–µ –ø—Ä–µ–¥–ª–æ–∂–∏–º.

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ. –õ—é–±–ª—é, –∫–æ–≥–¥–∞ —É –≤–∞—Å –≤—Å—ë —Ä–∞—Å—Ç—ë—Ç: –∏ –æ–≥–æ—Ä–æ–¥—ã, –∏ —Ä–µ–π—Ç–∏–Ω–≥.`,
  },
];

/* –ø–µ—á–∞—Ç–∞–ª–∫–∞ */
function useTypewriter(text: string, speed = 22) {
  const [out, setOut] = React.useState('');
  const [running, setRunning] = React.useState(false);

  const iRef = React.useRef(0);
  const timerRef = React.useRef<number | null>(null);
  const runRef = React.useRef(false);

  const clearTimer = () => {
    if (timerRef.current !== null) {
      window.clearTimeout(timerRef.current);
      timerRef.current = null;
    }
  };

  const step = React.useCallback(() => {
    if (!runRef.current) return;
    iRef.current += 1;
    setOut(text.slice(0, iRef.current));

    if (iRef.current < text.length) {
      timerRef.current = window.setTimeout(step, speed);
    } else {
      runRef.current = false;
      setRunning(false);
      clearTimer();
    }
  }, [text, speed]);

  const start = React.useCallback(() => {
    clearTimer();
    iRef.current = 0;
    setOut('');
    runRef.current = true;
    setRunning(true);
    timerRef.current = window.setTimeout(step, speed);
  }, [step, speed]);

  const stop = React.useCallback(() => {
    runRef.current = false;
    setRunning(false);
    clearTimer();
  }, []);

  React.useEffect(() => () => clearTimer(), []);
  React.useEffect(() => {
    setOut('');
    iRef.current = 0;
  }, [text]);

  return { out, running, start, stop, done: out.length >= text.length };
}

/* —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ */
const RAW_LINES: string[] = [
  '–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å –≤–∞—à–µ–π –º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–¥–ø–∏—Å–∏‚Ä¶',
  '–í–∞—à –≥—Ä–∏–º—É–∞—Ä –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è –≤ –ì–æ—Å–ì—Ä–∏–º–†–µ–µ—Å—Ç—Ä–µ‚Ä¶',
  '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –°–≤–µ–¥–µ–Ω–±–æ—Ä–≥–∞‚Ä¶',
  '–ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–æ—Ç–æ–∫ –º–∞–Ω—ã –∫ —Å–µ—Ä–≤–µ—Ä—É –ë–∞—à–Ω–∏ –í–µ–¥—å–º‚Ä¶',
  '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ—Ç –ª–∏ —É –≤–∞—Å –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –¥–µ–º–æ–Ω–∞–º–∏‚Ä¶',
  '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–µ—á–∞—Ç–µ–π –±—Ä–∞—á–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ —Å –ê—Ä–∫–∞–Ω–æ–π –°–æ–ª–Ω—Ü–∞‚Ä¶',
  '–ü–æ–¥–∫–ª—é—á–∞–µ–º –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –∫ —Å–∏—Å—Ç–µ–º–µ "–ú–∞–≥–∏—è –±–µ–∑ –≥—Ä–∞–Ω–∏—Ü"‚Ä¶',
  '–§–æ—Ä–º–∏—Ä—É–µ–º –æ—á–µ—Ä–µ–¥—å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤‚Ä¶',
  '–ü–µ—Ä–µ–ø—Ä–æ—à–∏–≤–∞–µ–º –≤–∞—à–∏ —Ç–æ–∫–∏ –º–∞–Ω—ã –¥–æ –≤–µ—Ä—Å–∏–∏ 3.2.1‚Ä¶',
  '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–∞–≥–∏—á–µ—Å–∫–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ª–∏—á–Ω–æ—Å—Ç–∏: –ø—Ä–∏–ª–æ–∂–∏—Ç–µ –ª–∞–¥–æ–Ω—å –∫ —ç–∫—Ä–∞–Ω—É!',
  '–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫–∑–∞–º–µ–Ω–∞ –≤ —à–∫–æ–ª—É –ê—Ä—Ö–∏–≤—É—Å‚Ä¶',
  '–ü—Ä–æ–≤–µ—Ä–∫–∞: –ø—Ä–æ—à–ª–∏ –ª–∏ –≤—ã —Ü–µ—Ä–µ–º–æ–Ω–∏—é –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä–∏–º—É–∞—Ä–∞?',
  '–í–∞—à–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–µ –°—É–¥–∞ –ú–∞–≥–æ–≤‚Ä¶',
  '–£—á–∏—Ç–µ–ª—è —à–∫–æ–ª—ã –õ–∏–∏ –∏ –ü–∞–≤–ª–µ—Ä–∞ —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç –¥–ª—è –≤–∞—Å —É—á–µ–±–Ω—ã–π –ø–ª–∞–Ω‚Ä¶',
  '–í–∞—à–∏ –æ—Ü–µ–Ω–∫–∏ –ø–æ –ü–ß–ö (–ø–æ—Ç–æ–∫ ‚Äî —á—É–≤—Å—Ç–≤–æ ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å) —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã!',
  '–û–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å—ã –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–∏–∫–æ–π –º–∞–≥–∏–µ–π‚Ä¶',
  '–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –°–≤–µ–¥–µ–Ω–±–æ—Ä–≥–∞‚Ä¶',
  '–ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–µ–±–Ω–æ–µ –ø–æ—Å–æ–±–∏–µ: "–ù–µ–∫—Ä–æ–º–∞–Ω—Ç–∏—è –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö".',
  '–í—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ —Ñ–∞–∫—É–ª—å—Ç–∞—Ç–∏–≤ "–ë–î–°–ú-–º–∞–≥–∏—é –ü–∞–≤–ª–µ—Ä–∞". üòè',
  '–û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞—à—É –±–æ–µ–≤—É—é —Ä–æ–ª—å: —Ç–∞–Ω–∫, —Ö–∏–ª–ª–µ—Ä, –±–∞—Ñ—Ñ–µ—Ä‚Ä¶ –ü–æ–¥–æ–∂–¥–∏—Ç–µ.',
  '–°–≤–µ—Ä—è–µ–º –≤–∞—Å —Å —Ä–µ–µ—Å—Ç—Ä–æ–º –†—ã—Ü–∞—Ä–µ–π –ß–∞—Ä–æ–¥–µ–µ–≤‚Ä¶',
  '–û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—É –∫–ª–∞–Ω–æ–≤ –ö–ª–µ–≤–µ—Ä–∞ –∏ –ê–ª–º–∞–∑–∞‚Ä¶',
  '–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç–µ –ª–∏ –≤—ã –∫ –ë–∞–≥—Ä–æ–≤—ã–º –õ—å–≤–∞–º?',
  '–í–∞—à–∏ –∑–∞—Å–ª—É–≥–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ –±–∞–∑—É –ß–µ—Ä–Ω—ã—Ö –ë—ã–∫–æ–≤‚Ä¶',
  '–°–≤–µ—Ä—è–µ–º –≤–∞—à —É—Ä–æ–≤–µ–Ω—å —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º –ú–∞–≥–∏—á–µ—Å–∫–∏—Ö –†—ã—Ü–∞—Ä–µ–π.',
  '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –≤–∞—à—É —Ä–æ–ª—å: –¥–µ–±–∞—Ñ—Ñ–µ—Ä —Å –ø—Ä–∞–≤–æ–º –Ω–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã.',
  '–í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ—Ç—Ä—è–¥–∞ –°–µ—Ä–µ–±—Ä—è–Ω—ã—Ö –û—Ä–ª–æ–≤.',
  '–í–∞—à –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –ü–∞–≤–ª–∏–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è‚Ä¶',
  '–û—à–∏–±–∫–∞ 404: –ö–∞–ø–∏—Ç–∞–Ω –Ø–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. üòÇ',
  '–°–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–µ–º –ø–æ—Ç–æ–∫–∏ –≤–∞—à–µ–π –º–∞–Ω—ã —Å –ú–∏–Ω–ú–∞–≥–≠–Ω–µ—Ä–≥–æ‚Ä¶',
  '–í—ã–ø–æ–ª–Ω—è–µ–º –æ—á–∏—Å—Ç–∫—É —Ç–æ–∫–æ–≤ –æ—Ç –º–∞–≥–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏‚Ä¶',
  '–í–Ω–∏–º–∞–Ω–∏–µ: –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–ª–µ–¥—ã —á—ë—Ä–Ω–æ–π –º–∞–≥–∏–∏. –°–æ–æ–±—â–∞–µ–º –≤ –ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä—É.',
  '–í–∞—à –∑–∞–ø–∞—Å –º–∞–Ω—ã –æ—Ü–µ–Ω–µ–Ω –∫–∞–∫ –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ ‚Äî –ø–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!',
  '–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è —Å –æ–±–ª–∞–∫–∞‚Ä¶',
  '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞–Ω—ã –ø–æ–¥ –∞—Å—Ç—Ä–∞–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã‚Ä¶',
  '–í–∞—à–∞ –∑–æ–Ω–∞ –º–∞–Ω—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ –Ω–∞ +3 –º–µ—Ç—Ä–∞!',
  '–ü–æ–¥–∫–ª—é—á–∞–µ–º –≤–∞—Å –∫ "Wi-Fi –º–∞–Ω—ã". –ü–∞—Ä–æ–ª—å: Lilith123.',
  '–°–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç: —É –≤–∞—Å —Ä–µ–¥–∫–∏–π –≥–∏–±—Ä–∏–¥ –º–∞–≥–∏–∏ ‚Äî —Å—Ç–µ–∫–ª–æ.',
  '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞! –°—Ä–æ—á–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∑–Ω–∞—Ö–∞—Ä—é –∏–ª–∏ –∞–ª—Ö–∏–º–∏–∫—É.',
  '–§–µ–Ω—Ä–∏—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∑–∞—â–∏—Ç—É —Å–µ–º—å–∏ –û—Å—Ñ–µ—Ä–∞‚Ä¶',
  '–®–µ–º–∑—É –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –≤–∞—à–µ–º—É —Å–Ω—É‚Ä¶',
  '–ê—Ä–ª–µ–∫–∏–Ω–∞ —É–ª—ã–±–∞–µ—Ç—Å—è –≤–∞–º –∏–∑ —Ç—É–º–∞–Ω–∞‚Ä¶',
  '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –ë–∞—à–Ω–∏ –í–µ–¥—å–º. –û—Å—Ç–æ—Ä–æ–∂–Ω–æ, –º–æ–≥—É—Ç –ø–æ—Ö–∏—Ç–∏—Ç—å.',
  '–†–µ–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞—à –±—Ä–∞—Å–ª–µ—Ç ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –±–∞—Ä—å–µ—Ä?',
  '–õ–∞–ª–æ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ —É–∫—Ä–∞—à–µ–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å‚Ä¶',
  '–§–µ–ª–∞ –≤–Ω–æ—Å–∏—Ç –≤–∞—à–∏ –Ω–∞–ª–æ–≥–∏ –≤ –∫–∞–∑–Ω—É –°–≤–µ–¥–µ–Ω–±–æ—Ä–≥–∞.',
  '–î—é–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è –≤–∞—à–∏–º –ø–µ—Ä–≤–µ–Ω—Ü–µ–º. –ü–æ–¥–æ–∂–¥–∏—Ç–µ‚Ä¶ üòà',
  '–°–∏—Å—Ç–µ–º–∞: —É –≤–∞—Å –µ—Å—Ç—å –¥–æ–ª–≥ –ø–µ—Ä–µ–¥ –ê—Ä–∫–∞–Ω–æ–π –°–æ–ª–Ω—Ü–∞.',
  '–í–Ω–∏–º–∞–Ω–∏–µ! –í –≤–∞—à–µ–π –∞—É—Ä–µ –∑–∞–º–µ—á–µ–Ω–æ –≤–ª–∏—è–Ω–∏–µ –ê—Ä–∫–∞–Ω—ã –î—å—è–≤–æ–ª–∞.',
  '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –≤–∞—à—É —É—á—ë—Ç–Ω—É—é –∑–∞–ø–∏—Å—å –Ω–∞ "–ì–æ—Å–ú–∞–≥–£—Å–ª—É–≥–∏".',
  '–í–∞—à–∏ –¥–µ—Ç–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –†–µ–µ—Å—Ç—Ä–µ –ú–∞–≥–∏—á–µ—Å–∫–∏—Ö –ì—Ä–∞–∂–¥–∞–Ω.',
  '–í—ã–ø–æ–ª–Ω—è–µ–º —Å–≤–µ—Ä–∫—É –≤–∞—à–µ–π –∞—É—Ä—ã —Å –Ω–∞–ª–æ–≥–∞–º–∏ –ø–æ –º–∞–Ω–µ.',
  '–û–∂–∏–¥–∞–µ–º –æ–¥–æ–±—Ä–µ–Ω–∏—è –≤–∞—à–µ–π –∑–∞—è–≤–∫–∏ –Ω–∞ —É—Å–∫–æ—Ä–µ–Ω–Ω—ã–µ —Ä–æ–¥—ã –æ—Ç –î—é–Ω—ã‚Ä¶',
  '–û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –ø–∞—Å–ø–æ—Ä—Ç –º–∞–≥–∞: —Ñ–æ—Ç–æ —Å –∞—É—Ä–æ–π.',
  '–ó–∞–≥—Ä—É–∂–∞–µ–º QR-–∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –ë–∞—à–Ω—é –í–µ–¥—å–º.',
  '–ü—Ä–æ–≤–µ—Ä–∫–∞: —É –≤–∞—Å –Ω–µ—Ç –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö —à—Ç—Ä–∞—Ñ–æ–≤ –∑–∞ –Ω–µ–∑–∞–∫–æ–Ω–Ω–æ–µ –∫–æ–ª–¥–æ–≤—Å—Ç–≤–æ.',
  '–í–∞—à–∏ –±—Ä–∞—á–Ω—ã–µ –∫–ª—è—Ç–≤—ã –∑–∞–≤–µ—Ä–µ–Ω—ã –Ω–æ—Ç–∞—Ä–∏—É—Å–æ–º –°–æ–ª–Ω—Ü–∞.',
  '–ü–æ–¥–∫–ª—é—á–∞–µ–º —Ü–∏—Ñ—Ä–æ–≤—É—é –ø–æ–¥–ø–∏—Å—å –¥–ª—è –ø—Ä–∏–∑—ã–≤–∞ —Ñ–∞–º–∏–ª—å—è—Ä–∞.',
  '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–∂–¥–∏—Ç–µ—Å—å –æ—Ç–≤–µ—Ç–∞ —Å–∏—Å—Ç–µ–º—ã. –í–∞—à –∑–∞–ø—Ä–æ—Å –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ 666 –∏–∑ 999. üëπ',
  '–í–∞—à —Ñ–∞–º–∏–ª—å—è—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ì–æ—Å–ó–≤–µ—Ä—å–£—á–µ—Ç.',
  '–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –º–∞–≥–∏—á–µ—Å–∫–∏—Ö –ø–∏—Ç–æ–º—Ü–µ–≤.',
  '–ü—Ä–æ–≤–µ—Ä–∫–∞: –≤–∞—à –µ–¥–∏–Ω–æ—Ä–æ–≥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º –Ω–æ—Ä–º–∞–º.',
  '–î—Ä–∞–∫–æ–Ω—ã –Ω–∞ —É—á—ë—Ç –ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã. –£ –≤–∞—Å –∏—Ö ‚Äî 0.',
  '–§–∞–º–∏–ª—å—è—Ä –Ω–µ–¥–æ–≤–æ–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–∫–æ—Ä–º–∏—Ç–µ –µ–≥–æ.',
  '–í–∞—à–∞ —Å–æ–≤–∞ —Å–¥–∞–ª–∞ —Ç–µ—Å—Ç –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É –ø–∏—Å–µ–º.',
  '–ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–æ–≤–µ–Ω—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –≤–∞—à–µ–≥–æ –≥–æ–±–ª–∏–Ω–∞‚Ä¶ –û—à–∏–±–∫–∞! üòÇ',
  '–î–æ–±–∞–≤–ª—è–µ–º –≤–∞—à–∏—Ö –¥—É—Ö–æ–≤-—Ö—Ä–∞–Ω–∏—Ç–µ–ª–µ–π –≤ –±–∞–∑—É.',
  '–ü—Ä–æ–≤–µ—Ä—è–µ–º: –≤–∞—à —Ñ–∞–º–∏–ª—å—è—Ä –Ω–µ —á–∏—Å–ª–∏—Ç—Å—è –≤ —Ä–æ–∑—ã—Å–∫–µ?',
  '–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—Ä—ã–ª—å–µ–≤ –ü–∞–≤–ª–µ—Ä–∞.',
  '–û—à–∏–±–∫–∞ 403: –¥–æ—Å—Ç—É–ø –∫ –º–∞–≥–∏–∏ –∫—Ä–æ–≤–∏ –∑–∞–ø—Ä–µ—â—ë–Ω.',
  '–û—à–∏–±–∫–∞ 500: –ø–µ—Ä–µ–≥—Ä–µ–≤ —Ç–æ–∫–æ–≤ –º–∞–Ω—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ö–∏–ª–ª–µ—Ä—É.',
  '–û—à–∏–±–∫–∞: –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∏–º—É–∞—Ä.',
  '–û—à–∏–±–∫–∞: –≤–∞—à–∞ –º–∞–≥–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–∞–Ω–Ω—ã–º —Ä–µ–≥–∏–æ–Ω–æ–º.',
  '–û—à–∏–±–∫–∞: –ø–æ—Ä—Ç–∞–ª –∑–∞–≤–∏—Å. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.',
  '–û—à–∏–±–∫–∞: —Ä–µ–±—ë–Ω–æ–∫ —Å –º–∞–≥–∏–µ–π —É–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ —Ç–µ–ª–∞. –°–∏—Å—Ç–µ–º–∞: –£–ù–ò–ß–¢–û–ñ–ò–¢–¨.',
  '–û—à–∏–±–∫–∞: –Ω–µ–∫—Ä–æ–º–∞–Ω—Ç–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –û–±–Ω–æ–≤–∏—Ç–µ –¥—Ä–∞–π–≤–µ—Ä —Å–º–µ—Ä—Ç–∏.',
  '–û—à–∏–±–∫–∞ 404: –≤–∞—à–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ –ª—é–±–≤–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.',
  '–û—à–∏–±–∫–∞ 101: —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –º–∞–Ω—ã, –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.',
  '–û—à–∏–±–∫–∞: –≤–∞—à–µ –ø—Ä–æ–∫–ª—è—Ç–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å —Ä–æ–¥–æ–≤—ã–º –±–∞—Ä—å–µ—Ä–æ–º.',
];

export default function Portal({ open, onClose }: Props) {
  const [phase, setPhase] = React.useState<Phase>('loading');
  const [progress, setProgress] = React.useState(0);
  const [lineIndex, setLineIndex] = React.useState(0);
  const [qSpeaking, setQSpeaking] = React.useState(false);

  // ‚ö†Ô∏è –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞: –ø–µ—Ä–µ–¥–∞—ë–º –≤ –∞–Ω–∫–µ—Ç—É –º–∞—Å—Å–∏–≤ –∫–ª–∞—Å—Å–æ–≤.
  const classes = CLASSES;

  const asstRef = React.useRef<AssistantDef | null>(null);
  if (!asstRef.current) {
    asstRef.current = ASSISTANTS[Math.floor(Math.random() * ASSISTANTS.length)];
  }

  const ASST = asstRef.current!;
  const currentText = phase === 'place' ? ASST.place : ASST.about;
  const tw = useTypewriter(currentText, 22);
  const speaking = (phase === 'about' || phase === 'place') && tw.running;

  React.useEffect(() => {
    if (!open) return;
    setPhase('loading');
    setProgress(0);
    setLineIndex(0);

    const totalMs = 20000;
    const t0 = Date.now();
    const timer = window.setInterval(() => {
      const p = Math.min(100, Math.round(((Date.now() - t0) / totalMs) * 100));
      setProgress(p);
      if (p >= 100) {
        window.clearInterval(timer);
        setPhase('welcome');
        window.setTimeout(() => setPhase('dialog'), 1000);
      }
    }, 120);

    const lines = window.setInterval(() => {
      setLineIndex((i) => (i + 1) % RAW_LINES.length);
    }, 1400);

    return () => {
      window.clearInterval(timer);
      window.clearInterval(lines);
    };
  }, [open]);

  React.useEffect(() => {
    if (phase === 'about' || phase === 'place') tw.start();
    else tw.stop();
  }, [phase]);

  React.useEffect(() => {
    if (!open) return;
    const onKey = (e: KeyboardEvent) => e.key === 'Escape' && onClose();
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [open, onClose]);

  if (!open) return null;
  const AssistantView = ASST.component;

  return (
    <div className="portal-backdrop" onClick={onClose}>
      <div className="portal-container solid" onClick={(e) => e.stopPropagation()}>
        <button className="portal-close" onClick={onClose} aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>

        {phase === 'loading' && (
          <section className="portal-panel">
            <div className="portal-heading">üåÄ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ì–æ—Å–ú–ê–ì-—É—Å–ª—É–≥–∞–º‚Ä¶</div>
            <div className="portal-loading-line">{RAW_LINES[lineIndex]}</div>
            <div className="portal-progress">
              <div className="portal-progress-bar" style={{ width: `${progress}%` }} />
            </div>
            <div className="portal-progress-hint">{progress}%</div>
          </section>
        )}

        {phase === 'welcome' && (
          <section className="portal-panel portal-center">
            <div className="portal-welcome">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ <b>–ì–æ—Å–ú–ê–ì-—É—Å–ª—É–≥–∏</b> ‚ú®</div>
            <div className="portal-subtle">–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–º–æ—â–Ω–∏–∫–∞‚Ä¶</div>
          </section>
        )}

        {(phase === 'dialog' || phase === 'about' || phase === 'place') && (
          <section className="portal-dialog">
            <AssistantView speaking={speaking} />
            <div className="asst-bubble">
              <div className="asst-meta">{ASST.name} ¬∑ {ASST.title}</div>

              {phase === 'dialog' && (
                <>
                  <div className="asst-text">–í—ã –∑–¥–µ—Å—å –≤–ø–µ—Ä–≤—ã–µ?</div>
                  <div className="asst-actions">
                    <button className="btn" onClick={() => alert('–ü–æ–∑–∂–µ –æ—Ç–∫—Ä–æ–µ–º —ç–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–∏—á–∫–∞')}>
                      –ù–µ—Ç, –º–µ–Ω—è —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏
                    </button>
                    <button className="btn primary" onClick={() => setPhase('questionnaire')}>
                      –î–∞, –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω(–∞)
                    </button>
                    <button className="btn" onClick={() => setPhase('about')}>–ö—Ç–æ —Ç—ã?</button>
                    <button className="btn" onClick={() => setPhase('place')}>–ì–¥–µ —è –Ω–∞—Ö–æ–∂—É—Å—å?</button>
                  </div>
                </>
              )}

              {phase === 'about' && (
                <>
                  <div className="asst-text">{tw.out || '\u00A0'}</div>
                  <div className="asst-actions">
                    <button className="btn" disabled={!tw.done} onClick={() => setPhase('dialog')}>
                      –ü–æ–Ω—è—Ç–Ω–æ
                    </button>
                  </div>
                </>
              )}

              {phase === 'place' && (
                <>
                  <div className="asst-text">{tw.out || '\u00A0'}</div>
                  <div className="asst-actions">
                    <button className="btn" disabled={!tw.done} onClick={() => setPhase('dialog')}>
                      –ü–æ–Ω—è—Ç–Ω–æ
                    </button>
                  </div>
                </>
              )}
            </div>
          </section>
        )}

        {/* ---- –û–¢–î–ï–õ–¨–ù–ê–Ø –í–ï–¢–ö–ê –î–õ–Ø –ê–ù–ö–ï–¢–´ ---- */}
        {phase === 'questionnaire' && (
          <section className="portal-dialog">
            <AssistantView speaking={qSpeaking} />

            {ASST.id === 'mereo' ? (
              <MerioQuestionnaire
                assistant={{ name: ASST.name, title: ASST.title }}
                variant={ASST.id as any}
                onSpeakingChange={setQSpeaking}
                classes={classes}
                onCancel={() => {
                  setQSpeaking(false);
                  setPhase('dialog');
                }}
                onFinish={(data) => {
                  console.log('–ê–Ω–∫–µ—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞:', data);
                  // --- –û–¢–ü–†–ê–í–ö–ê –í –í–ö –ß–ï–†–ï–ó NETLIFY FUNCTION ---
                  fetch('/.netlify/functions/vk-send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      formId: (crypto as any).randomUUID ? crypto.randomUUID() : String(Date.now()),
                      assistant: ASST.name,
                      data,
                    }),
                  })
                    .then(r => r.json())
                    .then(() => {
                      setQSpeaking(false);
                      setPhase('welcome');
                    })
                    .catch((err) => {
                      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –í–ö: ' + (err?.message || String(err)));
                      setQSpeaking(false);
                      setPhase('welcome');
                    });
                }}
              />
            ) : ASST.id === 'ren' ? (
              <RenQuestionnaire
                assistant={{ name: ASST.name, title: ASST.title }}
                variant={ASST.id as any}
                onSpeakingChange={setQSpeaking}
                classes={classes}
                onCancel={() => {
                  setQSpeaking(false);
                  setPhase('dialog');
                }}
                onFinish={(data) => {
                  console.log('–ê–Ω–∫–µ—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞:', data);
                  // --- –û–¢–ü–†–ê–í–ö–ê –í –í–ö –ß–ï–†–ï–ó NETLIFY FUNCTION ---
                  fetch('/.netlify/functions/vk-send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      formId: (crypto as any).randomUUID ? crypto.randomUUID() : String(Date.now()),
                      assistant: ASST.name,
                      data,
                    }),
                  })
                    .then(r => r.json())
                    .then(() => {
                      setQSpeaking(false);
                      setPhase('welcome');
                    })
                    .catch((err) => {
                      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –í–ö: ' + (err?.message || String(err)));
                      setQSpeaking(false);
                      setPhase('welcome');
                    });
                }}
              />
            ) : (
              <LuminQuestionnaire
                assistant={{ name: ASST.name, title: ASST.title }}
                variant={ASST.id as any}
                onSpeakingChange={setQSpeaking}
                classes={classes}
                onCancel={() => {
                  setQSpeaking(false);
                  setPhase('dialog');
                }}
                onFinish={(data) => {
                  console.log('–ê–Ω–∫–µ—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞:', data);
                  // --- –û–¢–ü–†–ê–í–ö–ê –í –í–ö –ß–ï–†–ï–ó NETLIFY FUNCTION ---
                  fetch('/.netlify/functions/vk-send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      formId: (crypto as any).randomUUID ? crypto.randomUUID() : String(Date.now()),
                      assistant: ASST.name,
                      data,
                    }),
                  })
                    .then(r => r.json())
                    .then(() => {
                      setQSpeaking(false);
                      setPhase('welcome');
                    })
                    .catch((err) => {
                      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –í–ö: ' + (err?.message || String(err)));
                      setQSpeaking(false);
                      setPhase('welcome');
                    });
                }}
              />
            )}
          </section>
        )}
      </div>
    </div>
  );
}
